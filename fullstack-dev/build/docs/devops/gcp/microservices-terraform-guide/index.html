<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-devops/gcp/microservices-terraform-guide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Comprehensive Microservices Architecture on GCP with Terraform | Full-Stack Developer</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tamnk74.github.io/fullstack-dev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tamnk74.github.io/fullstack-dev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tamnk74.github.io/fullstack-dev/docs/devops/gcp/microservices-terraform-guide"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Comprehensive Microservices Architecture on GCP with Terraform | Full-Stack Developer"><meta data-rh="true" name="description" content="This guide provides a complete Infrastructure as Code (IaC) solution for deploying production-ready microservices applications on Google Cloud Platform using Terraform."><meta data-rh="true" property="og:description" content="This guide provides a complete Infrastructure as Code (IaC) solution for deploying production-ready microservices applications on Google Cloud Platform using Terraform."><link data-rh="true" rel="icon" href="/fullstack-dev/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tamnk74.github.io/fullstack-dev/docs/devops/gcp/microservices-terraform-guide"><link data-rh="true" rel="alternate" href="https://tamnk74.github.io/fullstack-dev/docs/devops/gcp/microservices-terraform-guide" hreflang="en"><link data-rh="true" rel="alternate" href="https://tamnk74.github.io/fullstack-dev/docs/devops/gcp/microservices-terraform-guide" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Google Cloud Platform (GCP)","item":"https://tamnk74.github.io/fullstack-dev/docs/devops/gcp/"},{"@type":"ListItem","position":2,"name":"Comprehensive Microservices Architecture on GCP with Terraform","item":"https://tamnk74.github.io/fullstack-dev/docs/devops/gcp/microservices-terraform-guide"}]}</script><link rel="alternate" type="application/rss+xml" href="/fullstack-dev/blog/rss.xml" title="Full-Stack Developer RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/fullstack-dev/blog/atom.xml" title="Full-Stack Developer Atom Feed"><link rel="stylesheet" href="/fullstack-dev/assets/css/styles.cea5b983.css">
<script src="/fullstack-dev/assets/js/runtime~main.4b0d9134.js" defer="defer"></script>
<script src="/fullstack-dev/assets/js/main.c5582aa0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/fullstack-dev/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_xBMp" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/fullstack-dev/"><div class="navbar__logo"><img src="/fullstack-dev/img/logo.svg" alt="Full-Stack Developer Logo" class="themedComponent_tWxM themedComponent--light_blRk"><img src="/fullstack-dev/img/logo.svg" alt="Full-Stack Developer Logo" class="themedComponent_tWxM themedComponent--dark_BYAg"></div><b class="navbar__title text--truncate">Full-Stack Developer</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/fullstack-dev/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/fullstack-dev/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/tamnk74/fullstack-dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_aTGy"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_a2lC colorModeToggle_dz_9"><button class="clean-btn toggleButton_NhoO toggleButtonDisabled_YY0z" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_wlGf lightToggleIcon_CLAD"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_wlGf darkToggleIcon_g4y2"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_wlGf systemToggleIcon_jsWl"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Zkpp"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_ONWF"><div class="docsWrapper_vxvU"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Vowm" type="button"></button><div class="docRoot_pE24"><aside class="theme-doc-sidebar-container docSidebarContainer_z4Pq"><div class="sidebarViewport_v27S"><div class="sidebar_wLJ9"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_jpxi"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fullstack-dev/docs/intro"><span title="Introduction" class="linkLabel_B_lE">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/setup"><span title="Getting Started" class="categoryLinkLabel_TRr6">Getting Started</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/assessments/developer-assessment-with-development-plans"><span title="Career Development" class="categoryLinkLabel_TRr6">Career Development</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist" href="/fullstack-dev/docs/security-practices/"><span title="Security Practices" class="categoryLinkLabel_TRr6">Security Practices</span></a><button aria-label="Expand sidebar category &#x27;Security Practices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist" href="/fullstack-dev/docs/qa-practices/"><span title="QA Practices" class="categoryLinkLabel_TRr6">QA Practices</span></a><button aria-label="Expand sidebar category &#x27;QA Practices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist" href="/fullstack-dev/docs/architecture-practices/"><span title="Architecture Practices" class="categoryLinkLabel_TRr6">Architecture Practices</span></a><button aria-label="Expand sidebar category &#x27;Architecture Practices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist" href="/fullstack-dev/docs/coding-conventions/"><span title="Coding Conventions" class="categoryLinkLabel_TRr6">Coding Conventions</span></a><button aria-label="Expand sidebar category &#x27;Coding Conventions&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist" href="/fullstack-dev/docs/rag-recommendations/"><span title="RAG Recommendations" class="categoryLinkLabel_TRr6">RAG Recommendations</span></a><button aria-label="Expand sidebar category &#x27;RAG Recommendations&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/ai-machine-learning/vertex-ai-gemini-guide"><span title="AI &amp; Machine Learning" class="categoryLinkLabel_TRr6">AI &amp; Machine Learning</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/features"><span title="Features" class="categoryLinkLabel_TRr6">Features</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/fullstack-dev/docs/devops/gitops-microservices-gcp-guide"><span title="DevOps" class="categoryLinkLabel_TRr6">DevOps</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/fullstack-dev/docs/devops/gitops-microservices-gcp-guide"><span title="GitOps Microservices Deployment Guide: Node.js on GCP GKE with Kustomize and ArgoCD" class="linkLabel_B_lE">GitOps Microservices Deployment Guide: Node.js on GCP GKE with Kustomize and ArgoCD</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--active" tabindex="0" href="/fullstack-dev/docs/devops/gcp/"><span title="Google Cloud Platform (GCP)" class="categoryLinkLabel_TRr6">Google Cloud Platform (GCP)</span></a><button aria-label="Collapse sidebar category &#x27;Google Cloud Platform (GCP)&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/fullstack-dev/docs/devops/gcp/gke-cluster-setup"><span title="GKE Cluster Setup Guide" class="linkLabel_B_lE">GKE Cluster Setup Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/fullstack-dev/docs/devops/gcp/gke-ingress-setup"><span title="GKE Ingress Setup Guide" class="linkLabel_B_lE">GKE Ingress Setup Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/fullstack-dev/docs/devops/gcp/microservices-terraform-guide"><span title="Comprehensive Microservices Architecture on GCP with Terraform" class="linkLabel_B_lE">Comprehensive Microservices Architecture on GCP with Terraform</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/testing"><span title="Development" class="categoryLinkLabel_TRr6">Development</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/api-reference"><span title="API Reference" class="categoryLinkLabel_TRr6">API Reference</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/tutorial-basics/create-a-document"><span title="Tutorial" class="categoryLinkLabel_TRr6">Tutorial</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_pjix menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/fullstack-dev/docs/tutorial-extras/manage-docs-versions"><span title="Advanced" class="categoryLinkLabel_TRr6">Advanced</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_f9JK"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_wLLr"><div class="docItemContainer_h836"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_kFqd" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/fullstack-dev/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JJ0r"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">DevOps</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/fullstack-dev/docs/devops/gcp/"><span>Google Cloud Platform (GCP)</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Comprehensive Microservices Architecture on GCP with Terraform</span></li></ul></nav><div class="tocCollapsible_VDjt theme-doc-toc-mobile tocMobile_oZ3I"><button type="button" class="clean-btn tocCollapsibleButton_Fj9E">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Comprehensive Microservices Architecture on GCP with Terraform</h1></header>
<p>This guide provides a complete Infrastructure as Code (IaC) solution for deploying production-ready microservices applications on Google Cloud Platform using Terraform.</p>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents" translate="no">​</a></h2>
<ol>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#project-structure">Project Structure</a></li>
<li><a href="#core-infrastructure-setup">Core Infrastructure Setup</a></li>
<li><a href="#artifact-registry-configuration">Artifact Registry Configuration</a></li>
<li><a href="#secret-manager-setup">Secret Manager Setup</a></li>
<li><a href="#gke-cluster-for-microservices">GKE Cluster for Microservices</a></li>
<li><a href="#cloud-sql-database">Cloud SQL Database</a></li>
<li><a href="#redis-memorystore">Redis Memorystore</a></li>
<li><a href="#cloud-storage-buckets">Cloud Storage Buckets</a></li>
<li><a href="#pubsub-messaging">Pub/Sub Messaging</a></li>
<li><a href="#filestore-nfs">Filestore NFS</a></li>
<li><a href="#cloud-run-services">Cloud Run Services</a></li>
<li><a href="#networking-security">Networking &amp; Security</a></li>
<li><a href="#monitoring-logging">Monitoring &amp; Logging</a></li>
<li><a href="#cicd-pipeline">CI/CD Pipeline</a></li>
<li><a href="#deployment-guide">Deployment Guide</a></li>
<li><a href="#best-practices">Best Practices</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="architecture-overview">Architecture Overview<a href="#architecture-overview" class="hash-link" aria-label="Direct link to Architecture Overview" title="Direct link to Architecture Overview" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="high-level-architecture">High-Level Architecture<a href="#high-level-architecture" class="hash-link" aria-label="Direct link to High-Level Architecture" title="Direct link to High-Level Architecture" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-text codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                          Google Cloud Platform                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   Cloud     │  │   Cloud     │  │   Cloud     │              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   Load      │  │     CDN     │  │   Armor     │              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Balancer    │  │             │  │  (WAF)      │              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────┘  └─────────────┘  └─────────────┘              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           │               │               │                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────────────┐ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                    VPC Network                               │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │   Public    │  │   Private   │  │   Database  │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │   Subnet    │  │   Subnet    │  │   Subnet    │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │         │               │               │                   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌─────────────┐ ┌─────────────────────────────────────┐   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ Cloud Run   │ │           GKE Cluster               │   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ Services    │ │  ┌─────────┐ ┌─────────┐ ┌─────────┐│   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │             │ │  │ Node    │ │ Node    │ │ Node    ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ ┌─────────┐ │ │  │ Pool 1  │ │ Pool 2  │ │ Pool 3  ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ │Gateway  │ │ │  └─────────┘ └─────────┘ └─────────┘│   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ │Service  │ │ │                                     │   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ └─────────┘ │ │  ┌─────────────────────────────────┐│   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ ┌─────────┐ │ │  │        Microservices            ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ │Auth     │ │ │  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ │Service  │ │ │  │ │User │ │Order│ │Pay  │ │Notif│ ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ └─────────┘ │ │  │ │ Svc │ │ Svc │ │ Svc │ │ Svc │ ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └─────────────┘ │  │ └─────┘ └─────┘ └─────┘ └─────┘ ││   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────── │  └─────────────────────────────────┘│   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       └─────────────────────────────────────┘   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────────────┐ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                 Data Layer                                   │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  Cloud SQL  │  │ Memorystore │  │ Cloud       │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ (PostgreSQL)│  │   (Redis)   │  │ Storage     │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  Pub/Sub    │  │ Filestore   │  │ Artifact    │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ (Messaging) │  │   (NFS)     │  │ Registry    │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────────────┘ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────────────┐ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │               Security &amp; Management                          │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │   Secret    │  │ Cloud IAM   │  │ Cloud KMS   │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  Manager    │  │             │  │             │         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────────────┘ │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="technology-stack">Technology Stack<a href="#technology-stack" class="hash-link" aria-label="Direct link to Technology Stack" title="Direct link to Technology Stack" translate="no">​</a></h3>
<ul>
<li><strong>Container Orchestration</strong>: Google Kubernetes Engine (GKE)</li>
<li><strong>Serverless</strong>: Cloud Run</li>
<li><strong>Container Registry</strong>: Artifact Registry</li>
<li><strong>Databases</strong>: Cloud SQL (PostgreSQL), Memorystore (Redis)</li>
<li><strong>Storage</strong>: Cloud Storage, Filestore</li>
<li><strong>Messaging</strong>: Pub/Sub</li>
<li><strong>Security</strong>: Secret Manager, Cloud IAM, Cloud KMS</li>
<li><strong>Networking</strong>: VPC, Cloud Load Balancer, Cloud CDN</li>
<li><strong>Infrastructure</strong>: Terraform</li>
<li><strong>Monitoring</strong>: Cloud Monitoring, Cloud Logging</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="required-tools">Required Tools<a href="#required-tools" class="hash-link" aria-label="Direct link to Required Tools" title="Direct link to Required Tools" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Install required tools (macOS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brew install terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brew install google-cloud-sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brew install kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">brew install helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Install required tools (Linux)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://releases.hashicorp.com/terraform/1.6.2/terraform_1.6.2_linux_amd64.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip terraform_1.6.2_linux_amd64.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mv terraform /usr/local/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Google Cloud SDK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://sdk.cloud.google.com | bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ~/.bashrc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mv kubectl /usr/local/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl https://get.helm.sh/helm-v3.13.0-linux-amd64.tar.gz | tar xz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo mv linux-amd64/helm /usr/local/bin/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="gcp-project-setup">GCP Project Setup<a href="#gcp-project-setup" class="hash-link" aria-label="Direct link to GCP Project Setup" title="Direct link to GCP Project Setup" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Authenticate with Google Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud auth login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud auth application-default login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PROJECT_ID=&quot;your-microservices-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud config set project $PROJECT_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Enable required APIs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud services enable \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compute.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cloudresourcemanager.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    monitoring.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logging.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sql-component.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pubsub.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secretmanager.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    artifactregistry.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cloudkms.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    certificatemanager.googleapis.com \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dns.googleapis.com</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="service-account-setup">Service Account Setup<a href="#service-account-setup" class="hash-link" aria-label="Direct link to Service Account Setup" title="Direct link to Service Account Setup" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Create Terraform service account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud iam service-accounts create terraform-microservices \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --description=&quot;Terraform service account for microservices infrastructure&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --display-name=&quot;Terraform Microservices&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Grant necessary roles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ROLES=(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/editor&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/container.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/compute.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/storage.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/sql.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/redis.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/pubsub.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/file.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/run.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/secretmanager.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/artifactregistry.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/cloudkms.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/iam.serviceAccountAdmin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/resourcemanager.projectIamAdmin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;roles/dns.admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for role in &quot;${ROLES[@]}&quot;; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gcloud projects add-iam-policy-binding $PROJECT_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --member=&quot;serviceAccount:terraform-microservices@$PROJECT_ID.iam.gserviceaccount.com&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --role=&quot;$role&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Download service account key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud iam service-accounts keys create terraform-key.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --iam-account=terraform-microservices@$PROJECT_ID.iam.gserviceaccount.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set environment variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export GOOGLE_APPLICATION_CREDENTIALS=&quot;$(pwd)/terraform-key.json&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="project-structure">Project Structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project Structure" title="Direct link to Project Structure" translate="no">​</a></h2>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Create project structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p microservices-terraform/{modules,environments,scripts,k8s-manifests}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd microservices-terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Directory structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p modules/{networking,gke,storage,databases,messaging,security,monitoring,cloudrun}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p environments/{dev,staging,prod}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p scripts/{deploy,backup,monitoring}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p k8s-manifests/{base,overlays}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># microservices-terraform/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── terraform.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── versions.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── networking/          # VPC, subnets, firewall rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── gke/                # GKE cluster and node pools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── storage/            # Cloud Storage, Filestore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── databases/          # Cloud SQL, Memorystore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── messaging/          # Pub/Sub topics and subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── security/           # Secret Manager, IAM, KMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── monitoring/         # Cloud Monitoring, Logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   └── cloudrun/           # Cloud Run services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── environments/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── dev/                # Development environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── staging/            # Staging environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   └── prod/               # Production environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ├── scripts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── deploy/             # Deployment scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   ├── backup/             # Backup scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># │   └── monitoring/         # Monitoring scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># └── k8s-manifests/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     ├── base/               # Base Kubernetes manifests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#     └── overlays/           # Environment-specific overlays</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="core-infrastructure-setup">Core Infrastructure Setup<a href="#core-infrastructure-setup" class="hash-link" aria-label="Direct link to Core Infrastructure Setup" title="Direct link to Core Infrastructure Setup" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="provider-configuration">Provider Configuration<a href="#provider-configuration" class="hash-link" aria-label="Direct link to Provider Configuration" title="Direct link to Provider Configuration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># versions.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_version = &quot;&gt;= 1.6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    google = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/google&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 5.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    google-beta = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/google-beta&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 5.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/kubernetes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 2.23&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    helm = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/helm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 2.11&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backend &quot;gcs&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket = &quot;your-terraform-state-bucket&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prefix = &quot;microservices&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;google&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;google-beta&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;google_client_config&quot; &quot;default&quot; {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;kubernetes&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  host                   = &quot;https://${module.gke.cluster_endpoint}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  token                  = data.google_client_config.default.access_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_ca_certificate = base64decode(module.gke.cluster_ca_certificate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;helm&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubernetes {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host                   = &quot;https://${module.gke.cluster_endpoint}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    token                  = data.google_client_config.default.access_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster_ca_certificate = base64decode(module.gke.cluster_ca_certificate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="main-variables">Main Variables<a href="#main-variables" class="hash-link" aria-label="Direct link to Main Variables" title="Direct link to Main Variables" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;us-central1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;zones&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP zones&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = list(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = [&quot;us-central1-a&quot;, &quot;us-central1-b&quot;, &quot;us-central1-c&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name (dev, staging, prod)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;microservices-app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Networking variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;network_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;VPC network name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;microservices-network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;subnet_ranges&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Subnet CIDR ranges&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_subnet           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private_subnet          = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_subnet         = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gke_pods_range         = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gke_services_range     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_subnet      = &quot;10.1.0.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private_subnet     = &quot;10.1.1.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_subnet    = &quot;10.1.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gke_pods_range     = &quot;10.2.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gke_services_range = &quot;10.3.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GKE variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;gke_config&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;GKE cluster configuration&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster_name           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes_version     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_private_nodes   = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_private_endpoint = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    master_ipv4_cidr_block = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_network_policy  = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_workload_identity = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster_name           = &quot;microservices-cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes_version     = &quot;1.28&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_private_nodes   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_private_endpoint = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    master_ipv4_cidr_block = &quot;172.16.0.0/28&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_network_policy  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable_workload_identity = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;node_pools&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;GKE node pool configurations&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = map(object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    machine_type     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk_size_gb     = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk_type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image_type       = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto_repair      = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto_upgrade     = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preemptible      = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_count        = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_count        = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initial_node_count = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node_labels      = map(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node_taints = list(object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      key    = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value  = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      effect = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    system = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_type       = &quot;e2-medium&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disk_size_gb       = 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disk_type          = &quot;pd-ssd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image_type         = &quot;COS_CONTAINERD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_repair        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_upgrade       = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      preemptible        = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      min_count          = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_count          = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initial_node_count = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node_labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        workload-type = &quot;system&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node_taints = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applications = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_type       = &quot;e2-standard-4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disk_size_gb       = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disk_type          = &quot;pd-ssd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image_type         = &quot;COS_CONTAINERD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_repair        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_upgrade       = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      preemptible        = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      min_count          = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_count          = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initial_node_count = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node_labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        workload-type = &quot;applications&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node_taints = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spot = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      machine_type       = &quot;e2-standard-2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disk_size_gb       = 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disk_type          = &quot;pd-standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image_type         = &quot;COS_CONTAINERD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_repair        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_upgrade       = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      preemptible        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      min_count          = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_count          = 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      initial_node_count = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node_labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        workload-type = &quot;spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node_taints = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key    = &quot;spot&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value  = &quot;true&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        effect = &quot;NO_SCHEDULE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Database variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;database_config&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Database configuration&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_version     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_tier        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_disk_size   = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_disk_type   = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_memory_size_gb = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_tier           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_version        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_version     = &quot;15&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_tier        = &quot;db-custom-2-4096&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_disk_size   = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_disk_type   = &quot;PD_SSD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_memory_size_gb = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_tier           = &quot;STANDARD_HA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_version        = &quot;REDIS_7_0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Storage variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;storage_config&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Storage configuration&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_tier         = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_capacity_gb  = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket_force_destroy   = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket_versioning      = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_tier        = &quot;STANDARD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_capacity_gb = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket_force_destroy  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket_versioning     = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud Run variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;cloud_run_services&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Cloud Run service configurations&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = map(object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port            = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpu             = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memory          = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_instances   = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_instances   = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    concurrency     = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_seconds = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env_vars        = map(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gateway = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image           = &quot;gcr.io/PROJECT_ID/gateway:latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port            = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cpu             = &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memory          = &quot;512Mi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      min_instances   = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_instances   = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      concurrency     = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      timeout_seconds = 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      env_vars = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PORT = &quot;8080&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENV  = &quot;production&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image           = &quot;gcr.io/PROJECT_ID/auth:latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      port            = 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cpu             = &quot;0.5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memory          = &quot;256Mi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      min_instances   = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_instances   = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      concurrency     = 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      timeout_seconds = 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      env_vars = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PORT = &quot;8080&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ENV  = &quot;production&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="main-terraform-configuration">Main Terraform Configuration<a href="#main-terraform-configuration" class="hash-link" aria-label="Direct link to Main Terraform Configuration" title="Direct link to Main Terraform Configuration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Enable required APIs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_project_service&quot; &quot;required_apis&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;container.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;compute.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cloudresourcemanager.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;monitoring.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;logging.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;storage.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sqladmin.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;redis.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;pubsub.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;file.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;run.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;secretmanager.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;artifactregistry.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cloudkms.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;certificatemanager.googleapis.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dns.googleapis.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service = each.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable_dependent_services = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable_on_destroy         = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Networking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;networking&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/networking&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id      = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region          = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_name    = var.network_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_ranges   = var.subnet_ranges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment     = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [google_project_service.required_apis]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Security (KMS, Secret Manager, IAM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;security&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/security&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id        = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region            = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment       = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name  = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [google_project_service.required_apis]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Artifact Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;artifact_registry&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/artifact_registry&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id       = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region           = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment      = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [google_project_service.required_apis]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GKE Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;gke&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/gke&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id          = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region              = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zones               = var.zones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_id          = module.networking.network_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_id           = module.networking.private_subnet_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gke_config          = var.gke_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  node_pools          = var.node_pools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment         = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kms_key_ring_id     = module.security.kms_key_ring_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kms_crypto_key_id   = module.security.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [module.networking, module.security]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Databases (Cloud SQL PostgreSQL and Memorystore Redis)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;databases&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/databases&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id              = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region                  = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_id              = module.networking.network_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_subnet_id      = module.networking.database_subnet_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_config         = var.database_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment             = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name        = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kms_crypto_key_id       = module.security.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [module.networking, module.security]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Storage (Cloud Storage and Filestore)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;storage&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/storage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id        = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region            = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_id        = module.networking.network_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage_config    = var.storage_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment       = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name  = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kms_crypto_key_id = module.security.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [module.networking, module.security]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Messaging (Pub/Sub)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;messaging&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/messaging&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id        = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment       = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name  = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kms_crypto_key_id = module.security.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [module.security]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud Run Services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;cloudrun&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/cloudrun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id          = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region              = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cloud_run_services  = var.cloud_run_services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment         = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name    = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  artifact_registry_url = module.artifact_registry.repository_url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [module.artifact_registry, module.security]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Monitoring and Logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;monitoring&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./modules/monitoring&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id       = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region           = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment      = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_name = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gke_cluster_name = module.gke.cluster_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [module.gke]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="networking-module">Networking Module<a href="#networking-module" class="hash-link" aria-label="Direct link to Networking Module" title="Direct link to Networking Module" translate="no">​</a></h2>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/networking/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># VPC Network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_network&quot; &quot;vpc&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                    = &quot;${var.network_name}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auto_create_subnetworks = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description             = &quot;VPC network for ${var.environment} microservices&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Public Subnet (for load balancers, NAT gateways)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_subnetwork&quot; &quot;public_subnet&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name          = &quot;${var.network_name}-public-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ip_cidr_range = var.subnet_ranges.public_subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region        = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network       = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Public subnet for ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aggregation_interval = &quot;INTERVAL_10_MIN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_sampling        = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata             = &quot;INCLUDE_ALL_METADATA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Private Subnet (for GKE nodes, Cloud Run, VMs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_subnetwork&quot; &quot;private_subnet&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name          = &quot;${var.network_name}-private-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ip_cidr_range = var.subnet_ranges.private_subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region        = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network       = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Private subnet for ${var.environment} microservices&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Secondary ranges for GKE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secondary_ip_range {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    range_name    = &quot;gke-pods-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_cidr_range = var.subnet_ranges.gke_pods_range</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secondary_ip_range {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    range_name    = &quot;gke-services-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_cidr_range = var.subnet_ranges.gke_services_range</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private_ip_google_access = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aggregation_interval = &quot;INTERVAL_10_MIN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_sampling        = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata             = &quot;INCLUDE_ALL_METADATA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Database Subnet (for Cloud SQL, Memorystore)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_subnetwork&quot; &quot;database_subnet&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name          = &quot;${var.network_name}-database-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ip_cidr_range = var.subnet_ranges.database_subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region        = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network       = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Database subnet for ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private_ip_google_access = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aggregation_interval = &quot;INTERVAL_10_MIN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_sampling        = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata             = &quot;INCLUDE_ALL_METADATA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud Router for NAT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_router&quot; &quot;router&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name    = &quot;${var.network_name}-router-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region  = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bgp {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asn = 64514</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud NAT for private subnet internet access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_router_nat&quot; &quot;nat&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                               = &quot;${var.network_name}-nat-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  router                             = google_compute_router.router.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region                             = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nat_ip_allocate_option            = &quot;AUTO_ONLY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_subnetwork_ip_ranges_to_nat = &quot;ALL_SUBNETWORKS_ALL_IP_RANGES&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enable = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filter = &quot;ERRORS_ONLY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Global IP for load balancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_global_address&quot; &quot;lb_ip&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name         = &quot;${var.network_name}-lb-ip-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description  = &quot;Global IP for load balancer in ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ip_version   = &quot;IPV4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address_type = &quot;EXTERNAL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Firewall Rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_firewall&quot; &quot;allow_internal&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name    = &quot;${var.network_name}-allow-internal-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network = google_compute_network.vpc.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol = &quot;icmp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports    = [&quot;0-65535&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol = &quot;udp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports    = [&quot;0-65535&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_ranges = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var.subnet_ranges.public_subnet,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var.subnet_ranges.private_subnet,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var.subnet_ranges.database_subnet,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var.subnet_ranges.gke_pods_range,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var.subnet_ranges.gke_services_range</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target_tags = [&quot;internal&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Allow internal communication within VPC&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_firewall&quot; &quot;allow_ssh&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name    = &quot;${var.network_name}-allow-ssh-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network = google_compute_network.vpc.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports    = [&quot;22&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_ranges = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target_tags   = [&quot;ssh-allowed&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Allow SSH access&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_firewall&quot; &quot;allow_http_https&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name    = &quot;${var.network_name}-allow-http-https-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network = google_compute_network.vpc.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports    = [&quot;80&quot;, &quot;443&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_ranges = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target_tags   = [&quot;http-server&quot;, &quot;https-server&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Allow HTTP and HTTPS traffic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_firewall&quot; &quot;allow_gke_webhook&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name    = &quot;${var.network_name}-allow-gke-webhook-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network = google_compute_network.vpc.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allow {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol = &quot;tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports    = [&quot;443&quot;, &quot;8443&quot;, &quot;9443&quot;, &quot;15017&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_ranges = [&quot;172.16.0.0/28&quot;] # Master CIDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  target_tags   = [&quot;gke-node&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Allow GKE master to communicate with nodes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Private Service Connection for Cloud SQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_global_address&quot; &quot;private_service_connection&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name          = &quot;${var.network_name}-private-service-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  purpose       = &quot;VPC_PEERING&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address_type  = &quot;INTERNAL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefix_length = 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network       = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Private service connection for ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_service_networking_connection&quot; &quot;private_vpc_connection&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network                 = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service                 = &quot;servicenetworking.googleapis.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  reserved_peering_ranges = [google_compute_global_address.private_service_connection.name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/networking/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;network_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Name of the VPC network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;subnet_ranges&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Subnet CIDR ranges&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_subnet      = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private_subnet     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_subnet    = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gke_pods_range     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gke_services_range = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/networking/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;network_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the VPC network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_compute_network.vpc.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;network_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The name of the VPC network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_compute_network.vpc.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;public_subnet_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the public subnet&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_compute_subnetwork.public_subnet.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;private_subnet_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the private subnet&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_compute_subnetwork.private_subnet.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;database_subnet_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the database subnet&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_compute_subnetwork.database_subnet.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;gke_pods_range_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Name of the GKE pods secondary range&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;gke-pods-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;gke_services_range_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Name of the GKE services secondary range&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;gke-services-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;global_lb_ip&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Global load balancer IP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_compute_global_address.lb_ip.address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;private_service_connection&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Private service connection&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_service_networking_connection.private_vpc_connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="artifact-registry-configuration">Artifact Registry Configuration<a href="#artifact-registry-configuration" class="hash-link" aria-label="Direct link to Artifact Registry Configuration" title="Direct link to Artifact Registry Configuration" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="artifact-registry-module">Artifact Registry Module<a href="#artifact-registry-module" class="hash-link" aria-label="Direct link to Artifact Registry Module" title="Direct link to Artifact Registry Module" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/artifact_registry/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Docker repository for container images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_artifact_registry_repository&quot; &quot;docker_repo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location      = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository_id = &quot;${var.application_name}-docker-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Docker repository for ${var.application_name} in ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  format        = &quot;DOCKER&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Helm repository for Helm charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_artifact_registry_repository&quot; &quot;helm_repo&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location      = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository_id = &quot;${var.application_name}-helm-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description   = &quot;Helm repository for ${var.application_name} in ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  format        = &quot;DOCKER&quot;  # Helm charts are stored as OCI artifacts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type        = &quot;helm-charts&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IAM bindings for Artifact Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_artifact_registry_repository_iam_member&quot; &quot;docker_reader&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project    = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location   = google_artifact_registry_repository.docker_repo.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository = google_artifact_registry_repository.docker_repo.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = &quot;roles/artifactregistry.reader&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member     = &quot;serviceAccount:${var.project_id}-compute@developer.gserviceaccount.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_artifact_registry_repository_iam_member&quot; &quot;docker_writer&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project    = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location   = google_artifact_registry_repository.docker_repo.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository = google_artifact_registry_repository.docker_repo.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = &quot;roles/artifactregistry.writer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member     = &quot;serviceAccount:${var.project_id}-compute@developer.gserviceaccount.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Service account for CI/CD pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_service_account&quot; &quot;artifact_registry_sa&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_id   = &quot;${var.application_name}-ar-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display_name = &quot;Artifact Registry Service Account for ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description  = &quot;Service account for pushing to Artifact Registry in ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_service_account_key&quot; &quot;artifact_registry_key&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_account_id = google_service_account.artifact_registry_sa.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_artifact_registry_repository_iam_member&quot; &quot;ci_writer&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project    = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location   = google_artifact_registry_repository.docker_repo.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository = google_artifact_registry_repository.docker_repo.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = &quot;roles/artifactregistry.writer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member     = &quot;serviceAccount:${google_service_account.artifact_registry_sa.email}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_artifact_registry_repository_iam_member&quot; &quot;helm_ci_writer&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project    = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location   = google_artifact_registry_repository.helm_repo.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository = google_artifact_registry_repository.helm_repo.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = &quot;roles/artifactregistry.writer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member     = &quot;serviceAccount:${google_service_account.artifact_registry_sa.email}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/artifact_registry/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/artifact_registry/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;docker_repository_url&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Docker repository URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;${google_artifact_registry_repository.docker_repo.location}-docker.pkg.dev/${var.project_id}/${google_artifact_registry_repository.docker_repo.repository_id}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;helm_repository_url&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Helm repository URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;${google_artifact_registry_repository.helm_repo.location}-docker.pkg.dev/${var.project_id}/${google_artifact_registry_repository.helm_repo.repository_id}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;repository_url&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Main repository URL (alias for docker_repository_url)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;${google_artifact_registry_repository.docker_repo.location}-docker.pkg.dev/${var.project_id}/${google_artifact_registry_repository.docker_repo.repository_id}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;service_account_email&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Service account email for CI/CD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_service_account.artifact_registry_sa.email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;service_account_key&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Service account key for CI/CD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_service_account_key.artifact_registry_key.private_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sensitive   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="security-module">Security Module<a href="#security-module" class="hash-link" aria-label="Direct link to Security Module" title="Direct link to Security Module" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="kms-secret-manager-and-iam-configuration">KMS, Secret Manager, and IAM Configuration<a href="#kms-secret-manager-and-iam-configuration" class="hash-link" aria-label="Direct link to KMS, Secret Manager, and IAM Configuration" title="Direct link to KMS, Secret Manager, and IAM Configuration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/security/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># KMS Key Ring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_kms_key_ring&quot; &quot;key_ring&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${var.application_name}-keyring-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prevent_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># KMS Crypto Key for database encryption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_kms_crypto_key&quot; &quot;database_key&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${var.application_name}-database-key-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_ring = google_kms_key_ring.key_ring.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  purpose  = &quot;ENCRYPT_DECRYPT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version_template {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;GOOGLE_SYMMETRIC_ENCRYPTION&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prevent_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># KMS Crypto Key for application secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_kms_crypto_key&quot; &quot;secrets_key&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${var.application_name}-secrets-key-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_ring = google_kms_key_ring.key_ring.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  purpose  = &quot;ENCRYPT_DECRYPT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version_template {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    algorithm = &quot;GOOGLE_SYMMETRIC_ENCRYPTION&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prevent_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Secret Manager secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret&quot; &quot;database_password&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_id = &quot;${var.application_name}-db-password-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type        = &quot;database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret_version&quot; &quot;database_password_version&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret      = google_secret_manager_secret.database_password.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_data = random_password.database_password.result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;random_password&quot; &quot;database_password&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  length  = 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  special = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># JWT secret for authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret&quot; &quot;jwt_secret&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_id = &quot;${var.application_name}-jwt-secret-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type        = &quot;authentication&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret_version&quot; &quot;jwt_secret_version&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret      = google_secret_manager_secret.jwt_secret.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_data = random_password.jwt_secret.result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;random_password&quot; &quot;jwt_secret&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  length  = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  special = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># API keys for external services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret&quot; &quot;external_api_keys&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;stripe-api-key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sendgrid-api-key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;oauth-google-secret&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;oauth-github-secret&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_id = &quot;${var.application_name}-${each.key}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type        = &quot;api-key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Service accounts for microservices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_service_account&quot; &quot;microservice_accounts&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user-service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order-service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payment-service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification-service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;gateway-service&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_id   = &quot;${var.application_name}-${each.key}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display_name = &quot;Service Account for ${each.key} in ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description  = &quot;Service account for ${each.key} microservice&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IAM roles for microservices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_project_iam_member&quot; &quot;microservice_permissions&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for pair in setproduct(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      keys(google_service_account.microservice_accounts),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      [&quot;roles/secretmanager.secretAccessor&quot;, &quot;roles/cloudsql.client&quot;, &quot;roles/pubsub.publisher&quot;, &quot;roles/pubsub.subscriber&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) : &quot;${pair[0]}-${pair[1]}&quot; =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service_account = pair[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      role           = pair[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role    = each.value.role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member  = &quot;serviceAccount:${google_service_account.microservice_accounts[each.value.service_account].email}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Workload Identity bindings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_service_account_iam_member&quot; &quot;workload_identity_bindings&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = google_service_account.microservice_accounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_account_id = each.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role               = &quot;roles/iam.workloadIdentityUser&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member             = &quot;serviceAccount:${var.project_id}.svc.id.goog[${var.environment}/${each.key}]&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/security/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/security/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;kms_key_ring_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;KMS key ring ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_kms_key_ring.key_ring.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;kms_crypto_key_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;KMS crypto key ID for database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_kms_crypto_key.database_key.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;secrets_kms_key_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;KMS crypto key ID for secrets&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_kms_crypto_key.secrets_key.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;database_password_secret_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Database password secret ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_secret_manager_secret.database_password.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;jwt_secret_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;JWT secret ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_secret_manager_secret.jwt_secret.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;microservice_service_accounts&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Microservice service accounts&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, sa in google_service_account.microservice_accounts : name =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      email = sa.email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      id    = sa.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;external_api_secrets&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;External API secrets&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, secret in google_secret_manager_secret.external_api_keys : name =&gt; secret.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="databases-module">Databases Module<a href="#databases-module" class="hash-link" aria-label="Direct link to Databases Module" title="Direct link to Databases Module" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="cloud-sql-postgresql-and-memorystore-redis">Cloud SQL PostgreSQL and Memorystore Redis<a href="#cloud-sql-postgresql-and-memorystore-redis" class="hash-link" aria-label="Direct link to Cloud SQL PostgreSQL and Memorystore Redis" title="Direct link to Cloud SQL PostgreSQL and Memorystore Redis" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/databases/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud SQL PostgreSQL instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_database_instance&quot; &quot;postgres&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name             = &quot;${var.application_name}-postgres-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_version = &quot;POSTGRES_${var.database_config.postgres_version}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region          = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deletion_protection = var.environment == &quot;prod&quot; ? true : false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tier              = var.database_config.postgres_tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    availability_type = var.environment == &quot;prod&quot; ? &quot;REGIONAL&quot; : &quot;ZONAL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk_type         = var.database_config.postgres_disk_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk_size         = var.database_config.postgres_disk_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk_autoresize   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # IP configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ipv4_enabled                                  = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      private_network                               = var.network_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enable_private_path_for_google_cloud_services = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Backup configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled                        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      start_time                     = &quot;02:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      point_in_time_recovery_enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      transaction_log_retention_days = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      backup_retention_settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retained_backups = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retention_unit   = &quot;COUNT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Maintenance window</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maintenance_window {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      day          = 7 # Sunday</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hour         = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      update_track = &quot;stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Database flags for performance tuning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_flags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  = &quot;shared_preload_libraries&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value = &quot;pg_stat_statements,pg_hint_plan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_flags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  = &quot;log_statement&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value = &quot;all&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_flags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name  = &quot;log_min_duration_statement&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value = &quot;1000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Insights configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    insights_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      query_insights_enabled  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      record_application_tags = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      record_client_address   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # User labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user_labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Encryption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encryption_key_name = var.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [var.private_service_connection]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Databases for microservices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_database&quot; &quot;microservice_databases&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;users&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;orders&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payments&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notifications&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;audit&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${each.key}_${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance = google_sql_database_instance.postgres.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Database users for microservices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_user&quot; &quot;microservice_users&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user_service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order_service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payment_service&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification_service&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${each.key}_${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance = google_sql_database_instance.postgres.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  password = random_password.db_passwords[each.key].result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;random_password&quot; &quot;db_passwords&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user_service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order_service&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payment_service&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification_service&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  length  = 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  special = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Store database passwords in Secret Manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret&quot; &quot;db_passwords&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = random_password.db_passwords</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_id = &quot;${var.application_name}-${each.key}-db-password-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service     = each.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type        = &quot;database-password&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret_version&quot; &quot;db_password_versions&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = google_secret_manager_secret.db_passwords</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret      = each.value.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_data = random_password.db_passwords[each.key].result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Redis Memorystore instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_redis_instance&quot; &quot;cache&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name           = &quot;${var.application_name}-redis-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  memory_size_gb = var.database_config.redis_memory_size_gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tier           = var.database_config.redis_tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis_version  = var.database_config.redis_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region         = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Network configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authorized_network      = var.network_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  connect_mode           = &quot;PRIVATE_SERVICE_ACCESS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis_configs = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxmemory-policy = &quot;allkeys-lru&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    notify-keyspace-events = &quot;Ex&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Maintenance policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  maintenance_policy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weekly_maintenance_window {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      day = &quot;SUNDAY&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      start_time {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hours   = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        minutes = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seconds = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nanos   = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # High availability for production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replica_count = var.environment == &quot;prod&quot; ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  read_replicas_mode = var.environment == &quot;prod&quot; ? &quot;READ_REPLICAS_ENABLED&quot; : &quot;READ_REPLICAS_DISABLED&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Redis configuration secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret&quot; &quot;redis_config&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_id = &quot;${var.application_name}-redis-config-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type        = &quot;redis-config&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_secret_manager_secret_version&quot; &quot;redis_config_version&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret = google_secret_manager_secret.redis_config.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  secret_data = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host = google_redis_instance.cache.host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port = google_redis_instance.cache.port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth_enabled = google_redis_instance.cache.auth_enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/databases/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;network_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the VPC network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;database_subnet_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the database subnet&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;database_config&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Database configuration&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_version     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_tier        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_disk_size   = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_disk_type   = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_memory_size_gb = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_tier           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_version        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;kms_crypto_key_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;KMS crypto key ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;private_service_connection&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Private service connection&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/databases/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;postgres_instance_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;PostgreSQL instance name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_sql_database_instance.postgres.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;postgres_connection_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;PostgreSQL connection name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_sql_database_instance.postgres.connection_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;postgres_private_ip&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;PostgreSQL private IP address&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_sql_database_instance.postgres.private_ip_address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;redis_host&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Redis host&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_redis_instance.cache.host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;redis_port&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Redis port&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_redis_instance.cache.port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;database_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Database names&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for db_name, db in google_sql_database.microservice_databases : db_name =&gt; db.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;redis_config_secret_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Redis configuration secret ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_secret_manager_secret.redis_config.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="storage-module">Storage Module<a href="#storage-module" class="hash-link" aria-label="Direct link to Storage Module" title="Direct link to Storage Module" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="cloud-storage-and-filestore-configuration">Cloud Storage and Filestore Configuration<a href="#cloud-storage-and-filestore-configuration" class="hash-link" aria-label="Direct link to Cloud Storage and Filestore Configuration" title="Direct link to Cloud Storage and Filestore Configuration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/storage/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud Storage buckets for different purposes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_storage_bucket&quot; &quot;app_buckets&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;static-assets&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Static assets bucket&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public_read = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lifecycle_rules = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action = { type = &quot;Delete&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        condition = { age = 90 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user-uploads&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;User uploads bucket&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public_read = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lifecycle_rules = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action = { type = &quot;SetStorageClass&quot;, storage_class = &quot;COLDLINE&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        condition = { age = 30 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;backups&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Database and application backups&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public_read = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lifecycle_rules = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action = { type = &quot;SetStorageClass&quot;, storage_class = &quot;ARCHIVE&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        condition = { age = 7 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;logs&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Application and audit logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public_read = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lifecycle_rules = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action = { type = &quot;Delete&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        condition = { age = 365 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;data-lake&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Data lake for analytics&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      public_read = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lifecycle_rules = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action = { type = &quot;SetStorageClass&quot;, storage_class = &quot;NEARLINE&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        condition = { age = 30 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name          = &quot;${var.application_name}-${each.key}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location      = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  force_destroy = var.storage_config.bucket_force_destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Uniform bucket-level access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uniform_bucket_level_access = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Versioning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  versioning {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled = var.storage_config.bucket_versioning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Encryption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encryption {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_kms_key_name = var.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Lifecycle management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dynamic &quot;lifecycle_rule&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for_each = each.value.lifecycle_rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      action {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type          = lifecycle_rule.value.action.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage_class = lookup(lifecycle_rule.value.action, &quot;storage_class&quot;, null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      condition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        age = lifecycle_rule.value.condition.age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # CORS configuration for static assets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dynamic &quot;cors&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for_each = each.key == &quot;static-assets&quot; ? [1] : []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      origin          = [&quot;*&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      method          = [&quot;GET&quot;, &quot;HEAD&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      response_header = [&quot;*&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_age_seconds = 3600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    purpose     = each.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Public access for static assets bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_storage_bucket_iam_member&quot; &quot;static_assets_public_read&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = google_storage_bucket.app_buckets[&quot;static-assets&quot;].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role   = &quot;roles/storage.objectViewer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member = &quot;allUsers&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Filestore instance for shared storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_filestore_instance&quot; &quot;shared_storage&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${var.application_name}-filestore-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tier     = var.storage_config.filestore_tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file_shares {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capacity_gb = var.storage_config.filestore_capacity_gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name        = &quot;shared&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  networks {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    network = var.network_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modes   = [&quot;MODE_IPV4&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Service accounts for storage access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_service_account&quot; &quot;storage_service_accounts&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;static-assets&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user-uploads&quot;, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;backups&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;logs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_id   = &quot;${var.application_name}-${each.key}-sa-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display_name = &quot;Service Account for ${each.key} storage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description  = &quot;Service account for accessing ${each.key} bucket&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IAM bindings for storage service accounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_storage_bucket_iam_member&quot; &quot;storage_access&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = google_service_account.storage_service_accounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bucket = google_storage_bucket.app_buckets[each.key].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role   = &quot;roles/storage.objectAdmin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member = &quot;serviceAccount:${each.value.email}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/storage/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;network_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The ID of the VPC network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;storage_config&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Storage configuration&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_tier        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_capacity_gb = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket_force_destroy  = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bucket_versioning     = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;kms_crypto_key_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;KMS crypto key ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/storage/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;bucket_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Storage bucket names&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, bucket in google_storage_bucket.app_buckets : name =&gt; bucket.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;bucket_urls&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Storage bucket URLs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, bucket in google_storage_bucket.app_buckets : name =&gt; bucket.url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;filestore_ip&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Filestore IP address&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_filestore_instance.shared_storage.networks[0].ip_addresses[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;filestore_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Filestore instance name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = google_filestore_instance.shared_storage.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;storage_service_accounts&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Storage service account emails&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, sa in google_service_account.storage_service_accounts : name =&gt; sa.email</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="messaging-module">Messaging Module<a href="#messaging-module" class="hash-link" aria-label="Direct link to Messaging Module" title="Direct link to Messaging Module" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="pubsub-configuration">Pub/Sub Configuration<a href="#pubsub-configuration" class="hash-link" aria-label="Direct link to Pub/Sub Configuration" title="Direct link to Pub/Sub Configuration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/messaging/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Pub/Sub topics for microservices communication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_pubsub_topic&quot; &quot;topics&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;User lifecycle events (created, updated, deleted)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;604800s&quot; # 7 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Order lifecycle events (created, updated, cancelled, completed)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;2592000s&quot; # 30 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payment-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Payment events (initiated, completed, failed, refunded)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;2592000s&quot; # 30 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Notification events (email, sms, push)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;259200s&quot; # 3 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;audit-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Audit trail events for compliance&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;7776000s&quot; # 90 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;analytics-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Analytics and tracking events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;1209600s&quot; # 14 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;dead-letter&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description = &quot;Dead letter queue for failed message processing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retention   = &quot;2592000s&quot; # 30 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;${var.application_name}-${each.key}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Message retention duration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  message_retention_duration = each.value.retention</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Encryption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kms_key_name = var.kms_crypto_key_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    purpose     = each.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Pub/Sub subscriptions for microservices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_pubsub_subscription&quot; &quot;subscriptions&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # User service subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;user-service-user-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;user-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Order service subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order-service-user-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;user-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;attributes.event_type = \&quot;created\&quot; OR attributes.event_type = \&quot;updated\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order-service-payment-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;payment-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;attributes.event_type = \&quot;completed\&quot; OR attributes.event_type = \&quot;failed\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Payment service subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payment-service-order-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;order-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;attributes.event_type = \&quot;created\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Notification service subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification-service-user-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;user-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification-service-order-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;order-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;notification-service-payment-events&quot; = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic                = &quot;payment-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ack_deadline_seconds = 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dead_letter_topic    = &quot;dead-letter&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter              = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name  = &quot;${var.application_name}-${each.key}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  topic = google_pubsub_topic.topics[each.value.topic].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Acknowledgment deadline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ack_deadline_seconds = each.value.ack_deadline_seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Message filtering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filter = each.value.filter != &quot;&quot; ? each.value.filter : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Dead letter policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dead_letter_policy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dead_letter_topic     = google_pubsub_topic.topics[each.value.dead_letter_topic].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_delivery_attempts = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Retry policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retry_policy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minimum_backoff = &quot;10s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    maximum_backoff = &quot;600s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Enable message ordering for critical subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable_message_ordering = contains([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;order-service-payment-events&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;payment-service-order-events&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ], each.key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service     = split(&quot;-&quot;, each.key)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IAM bindings for Pub/Sub access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_pubsub_topic_iam_member&quot; &quot;publishers&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for pair in setproduct(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      keys(google_pubsub_topic.topics),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      [&quot;user-service&quot;, &quot;order-service&quot;, &quot;payment-service&quot;, &quot;notification-service&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) : &quot;${pair[1]}-${pair[0]}&quot; =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic   = pair[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service = pair[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  topic  = google_pubsub_topic.topics[each.value.topic].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role   = &quot;roles/pubsub.publisher&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member = &quot;serviceAccount:${var.application_name}-${each.value.service}-${var.environment}@${var.project_id}.iam.gserviceaccount.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_pubsub_subscription_iam_member&quot; &quot;subscribers&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = google_pubsub_subscription.subscriptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subscription = each.value.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role        = &quot;roles/pubsub.subscriber&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member      = &quot;serviceAccount:${var.application_name}-${split(&quot;-&quot;, each.key)[0]}-service-${var.environment}@${var.project_id}.iam.gserviceaccount.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/messaging/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;kms_crypto_key_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;KMS crypto key ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/messaging/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;topic_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Pub/Sub topic names&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, topic in google_pubsub_topic.topics : name =&gt; topic.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;subscription_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Pub/Sub subscription names&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, subscription in google_pubsub_subscription.subscriptions : name =&gt; subscription.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="cloud-run-module">Cloud Run Module<a href="#cloud-run-module" class="hash-link" aria-label="Direct link to Cloud Run Module" title="Direct link to Cloud Run Module" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="serverless-microservices-configuration">Serverless Microservices Configuration<a href="#serverless-microservices-configuration" class="hash-link" aria-label="Direct link to Serverless Microservices Configuration" title="Direct link to Serverless Microservices Configuration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/cloudrun/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud Run services for serverless microservices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_cloud_run_v2_service&quot; &quot;services&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = var.cloud_run_services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${var.application_name}-${each.key}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress  = &quot;INGRESS_TRAFFIC_ALL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Service account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service_account = &quot;${var.application_name}-${each.key}-service-${var.environment}@${var.project_id}.iam.gserviceaccount.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Scaling configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scaling {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      min_instance_count = each.value.min_instances</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_instance_count = each.value.max_instances</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Container configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image = &quot;${var.artifact_registry_url}/${each.key}:latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Resource allocation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      resources {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        limits = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cpu    = each.value.cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          memory = each.value.memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cpu_idle = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        startup_cpu_boost = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Port configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        container_port = each.value.port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name           = &quot;http1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Environment variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dynamic &quot;env&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for_each = each.value.env_vars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name  = env.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          value = env.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Environment variables from secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      env {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name = &quot;DATABASE_URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value_source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          secret_key_ref {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secret  = &quot;${var.application_name}-${each.key}-db-password-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            version = &quot;latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      env {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name = &quot;REDIS_URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value_source {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          secret_key_ref {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secret  = &quot;${var.application_name}-redis-config-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            version = &quot;latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Health check configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      startup_probe {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http_get {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          path = &quot;/health&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          port = each.value.port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initial_delay_seconds = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timeout_seconds      = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        period_seconds       = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        failure_threshold    = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      liveness_probe {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http_get {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          path = &quot;/health&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          port = each.value.port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        initial_delay_seconds = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timeout_seconds      = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        period_seconds       = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        failure_threshold    = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Request timeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout = &quot;${each.value.timeout_seconds}s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Maximum requests per container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_instance_request_concurrency = each.value.concurrency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Execution environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    execution_environment = &quot;EXECUTION_ENVIRONMENT_GEN2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Traffic configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  traffic {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type    = &quot;TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    percent = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application = var.application_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service     = each.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    managed_by  = &quot;terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Lifecycle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lifecycle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_changes = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      template[0].containers[0].image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IAM policy for Cloud Run services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_cloud_run_service_iam_member&quot; &quot;public_access&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = var.cloud_run_services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service  = google_cloud_run_v2_service.services[each.key].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location = google_cloud_run_v2_service.services[each.key].location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role     = &quot;roles/run.invoker&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  member   = &quot;allUsers&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Load balancer backend for Cloud Run services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_compute_region_network_endpoint_group&quot; &quot;cloud_run_neg&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = var.cloud_run_services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;${var.application_name}-${each.key}-neg-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_endpoint_type = &quot;SERVERLESS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region                = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cloud_run {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service = google_cloud_run_v2_service.services[each.key].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/cloudrun/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;cloud_run_services&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Cloud Run service configurations&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = map(object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image           = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port            = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpu             = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memory          = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_instances   = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_instances   = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    concurrency     = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_seconds = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    env_vars        = map(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;artifact_registry_url&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Artifact Registry URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/cloudrun/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;service_urls&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Cloud Run service URLs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, service in google_cloud_run_v2_service.services : name =&gt; service.uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;service_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Cloud Run service names&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for name, service in google_cloud_run_v2_service.services : name =&gt; service.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="monitoring-module">Monitoring Module<a href="#monitoring-module" class="hash-link" aria-label="Direct link to Monitoring Module" title="Direct link to Monitoring Module" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="cloud-operations-integration">Cloud Operations Integration<a href="#cloud-operations-integration" class="hash-link" aria-label="Direct link to Cloud Operations Integration" title="Direct link to Cloud Operations Integration" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/monitoring/main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Notification channels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_monitoring_notification_channel&quot; &quot;email&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_each = toset([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;devops-team@company.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sre-team@company.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display_name = &quot;Email - ${each.key}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type         = &quot;email&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email_address = each.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Alert policies for infrastructure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_monitoring_alert_policy&quot; &quot;high_cpu&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display_name = &quot;${var.application_name} - High CPU Usage - ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  combiner     = &quot;OR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conditions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_name = &quot;CPU usage is above 80%&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition_threshold {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter          = &quot;metric.type=\&quot;compute.googleapis.com/instance/cpu/utilization\&quot; resource.type=\&quot;gce_instance\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      duration        = &quot;300s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparison      = &quot;COMPARISON_GREATER_THAN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      threshold_value = 0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      aggregations {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        alignment_period   = &quot;60s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        per_series_aligner = &quot;ALIGN_RATE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  notification_channels = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for channel in google_monitoring_notification_channel.email : channel.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GKE cluster monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_monitoring_alert_policy&quot; &quot;gke_node_not_ready&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  display_name = &quot;${var.application_name} - GKE Node Not Ready - ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  combiner     = &quot;OR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conditions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_name = &quot;GKE node is not ready&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition_threshold {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      filter          = &quot;metric.type=\&quot;kubernetes.io/node/ready\&quot; resource.type=\&quot;k8s_node\&quot; resource.label.cluster_name=\&quot;${var.gke_cluster_name}\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      duration        = &quot;300s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      comparison      = &quot;COMPARISON_LESS_THAN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      threshold_value = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      aggregations {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        alignment_period   = &quot;60s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        per_series_aligner = &quot;ALIGN_MEAN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  notification_channels = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for channel in google_monitoring_notification_channel.email : channel.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Application-level monitoring dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_monitoring_dashboard&quot; &quot;microservices_dashboard&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dashboard_json = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    displayName = &quot;${var.application_name} Microservices Dashboard - ${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mosaicLayout = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tiles = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          width  = 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          height = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          widget = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title = &quot;GKE Cluster CPU Usage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            xyChart = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              dataSets = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                timeSeriesQuery = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  timeSeriesFilter = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    filter = &quot;metric.type=\&quot;kubernetes.io/container/cpu/core_usage_time\&quot; resource.type=\&quot;k8s_container\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    aggregation = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      alignmentPeriod  = &quot;60s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      perSeriesAligner = &quot;ALIGN_RATE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          width  = 6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          height = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          widget = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            title = &quot;GKE Cluster Memory Usage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            xyChart = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              dataSets = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                timeSeriesQuery = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  timeSeriesFilter = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    filter = &quot;metric.type=\&quot;kubernetes.io/container/memory/used_bytes\&quot; resource.type=\&quot;k8s_container\&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    aggregation = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      alignmentPeriod  = &quot;60s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      perSeriesAligner = &quot;ALIGN_MEAN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/monitoring/variables.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP project ID&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;The GCP region&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;application_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Application name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;gke_cluster_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;GKE cluster name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># modules/monitoring/outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;notification_channels&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Monitoring notification channels&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for email, channel in google_monitoring_notification_channel.email : email =&gt; channel.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;dashboard_url&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Monitoring dashboard URL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;https://console.cloud.google.com/monitoring/dashboards/custom/${google_monitoring_dashboard.microservices_dashboard.id}?project=${var.project_id}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="complete-terraform-configuration">Complete Terraform Configuration<a href="#complete-terraform-configuration" class="hash-link" aria-label="Direct link to Complete Terraform Configuration" title="Direct link to Complete Terraform Configuration" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="main-outputs">Main Outputs<a href="#main-outputs" class="hash-link" aria-label="Direct link to Main Outputs" title="Direct link to Main Outputs" translate="no">​</a></h3>
<div class="language-hcl codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-hcl codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># outputs.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;cluster_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;GKE cluster information&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name      = module.gke.cluster_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location  = module.gke.cluster_location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint  = module.gke.cluster_endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sensitive = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;database_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Database connection information&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_instance = module.databases.postgres_instance_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    postgres_ip       = module.databases.postgres_private_ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_host        = module.databases.redis_host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis_port        = module.databases.redis_port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sensitive = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;storage_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Storage information&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buckets     = module.storage.bucket_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filestore_ip = module.storage.filestore_ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;cloud_run_urls&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Cloud Run service URLs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = module.cloudrun.service_urls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;messaging_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Pub/Sub messaging information&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    topics        = module.messaging.topic_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subscriptions = module.messaging.subscription_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;monitoring_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Monitoring and observability&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dashboard_url = module.monitoring.dashboard_url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;kubectl_connection_command&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Command to connect kubectl to the cluster&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = &quot;gcloud container clusters get-credentials ${module.gke.cluster_name} --region ${module.gke.cluster_location} --project ${var.project_id}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="deployment-guide">Deployment Guide<a href="#deployment-guide" class="hash-link" aria-label="Direct link to Deployment Guide" title="Direct link to Deployment Guide" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="step-1-prerequisites-setup">Step 1: Prerequisites Setup<a href="#step-1-prerequisites-setup" class="hash-link" aria-label="Direct link to Step 1: Prerequisites Setup" title="Direct link to Step 1: Prerequisites Setup" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Clone your Terraform configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/your-org/microservices-terraform.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd microservices-terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Initialize Terraform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create terraform.tfvars for your environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp environments/dev/terraform.tfvars.example terraform.tfvars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Edit terraform.tfvars with your specific values</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="step-2-plan-and-deploy">Step 2: Plan and Deploy<a href="#step-2-plan-and-deploy" class="hash-link" aria-label="Direct link to Step 2: Plan and Deploy" title="Direct link to Step 2: Plan and Deploy" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Validate configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Plan the deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan -var-file=&quot;terraform.tfvars&quot; -out=tfplan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Review the plan carefully</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform show tfplan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Apply the infrastructure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply tfplan</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="step-3-post-deployment-setup">Step 3: Post-Deployment Setup<a href="#step-3-post-deployment-setup" class="hash-link" aria-label="Direct link to Step 3: Post-Deployment Setup" title="Direct link to Step 3: Post-Deployment Setup" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Get cluster credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container clusters get-credentials microservices-cluster-dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region us-central1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --project your-microservices-dev-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Verify cluster access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create application namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create namespace dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Set up Workload Identity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl annotate serviceaccount default \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    iam.gke.io/gcp-service-account=microservices-app-gateway-service-dev@your-project.iam.gserviceaccount.com</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="step-4-deploy-application">Step 4: Deploy Application<a href="#step-4-deploy-application" class="hash-link" aria-label="Direct link to Step 4: Deploy Application" title="Direct link to Step 4: Deploy Application" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Build and push container images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t us-central1-docker.pkg.dev/PROJECT_ID/microservices-app-docker-dev/gateway:latest gateway/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push us-central1-docker.pkg.dev/PROJECT_ID/microservices-app-docker-dev/gateway:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t us-central1-docker.pkg.dev/PROJECT_ID/microservices-app-docker-dev/auth:latest auth/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push us-central1-docker.pkg.dev/PROJECT_ID/microservices-app-docker-dev/auth:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Deploy to Cloud Run (if using Cloud Run)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run deploy gateway \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --image us-central1-docker.pkg.dev/PROJECT_ID/microservices-app-docker-dev/gateway:latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region us-central1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --platform managed \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --allow-unauthenticated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Or deploy to GKE using kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f k8s-manifests/</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="step-5-verify-deployment">Step 5: Verify Deployment<a href="#step-5-verify-deployment" class="hash-link" aria-label="Direct link to Step 5: Verify Deployment" title="Direct link to Step 5: Verify Deployment" translate="no">​</a></h3>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Check Cloud Run services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run services list --region us-central1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check GKE deployments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get services -n dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check database connectivity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run test-pod --image=postgres:15 --rm -it --restart=Never -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    psql -h &lt;POSTGRES_IP&gt; -U user_service_dev -d users_dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check Redis connectivity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl run test-pod --image=redis:7 --rm -it --restart=Never -- \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis-cli -h &lt;REDIS_HOST&gt; ping</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="security-best-practices">Security Best Practices<a href="#security-best-practices" class="hash-link" aria-label="Direct link to Security Best Practices" title="Direct link to Security Best Practices" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Least Privilege Access</strong></p>
<ul>
<li>Use separate service accounts for each microservice</li>
<li>Grant minimal required permissions</li>
<li>Enable Workload Identity for GKE pods</li>
</ul>
</li>
<li>
<p><strong>Encryption at Rest and in Transit</strong></p>
<ul>
<li>Use Cloud KMS for database encryption</li>
<li>Enable TLS for all communications</li>
<li>Encrypt secrets in Secret Manager</li>
</ul>
</li>
<li>
<p><strong>Network Security</strong></p>
<ul>
<li>Use private GKE clusters</li>
<li>Implement network policies</li>
<li>Use authorized networks for database access</li>
</ul>
</li>
<li>
<p><strong>Secret Management</strong></p>
<ul>
<li>Store all sensitive data in Secret Manager</li>
<li>Use IAM to control secret access</li>
<li>Rotate secrets regularly</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="performance-optimization">Performance Optimization<a href="#performance-optimization" class="hash-link" aria-label="Direct link to Performance Optimization" title="Direct link to Performance Optimization" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Resource Management</strong></p>
<ul>
<li>Set appropriate CPU and memory limits</li>
<li>Use horizontal pod autoscaling</li>
<li>Configure cluster autoscaling</li>
</ul>
</li>
<li>
<p><strong>Database Optimization</strong></p>
<ul>
<li>Use read replicas for analytics workloads</li>
<li>Configure connection pooling</li>
<li>Monitor query performance</li>
</ul>
</li>
<li>
<p><strong>Caching Strategy</strong></p>
<ul>
<li>Use Redis for session and application caching</li>
<li>Implement CDN for static assets</li>
<li>Cache frequently accessed data</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="cost-optimization">Cost Optimization<a href="#cost-optimization" class="hash-link" aria-label="Direct link to Cost Optimization" title="Direct link to Cost Optimization" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Right-sizing Resources</strong></p>
<ul>
<li>Use preemptible instances for non-critical workloads</li>
<li>Scale down development environments</li>
<li>Monitor resource utilization</li>
</ul>
</li>
<li>
<p><strong>Storage Optimization</strong></p>
<ul>
<li>Use lifecycle policies for Cloud Storage</li>
<li>Choose appropriate storage classes</li>
<li>Clean up unused resources</li>
</ul>
</li>
<li>
<p><strong>Monitoring and Alerting</strong></p>
<ul>
<li>Set up budget alerts</li>
<li>Monitor resource usage trends</li>
<li>Use committed use discounts for stable workloads</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="operational-excellence">Operational Excellence<a href="#operational-excellence" class="hash-link" aria-label="Direct link to Operational Excellence" title="Direct link to Operational Excellence" translate="no">​</a></h3>
<ol>
<li>
<p><strong>Infrastructure as Code</strong></p>
<ul>
<li>Version control all Terraform configurations</li>
<li>Use environment-specific configurations</li>
<li>Implement automated testing</li>
</ul>
</li>
<li>
<p><strong>CI/CD Pipeline</strong></p>
<ul>
<li>Automate infrastructure deployments</li>
<li>Use GitOps for application deployments</li>
<li>Implement automated testing</li>
</ul>
</li>
<li>
<p><strong>Monitoring and Observability</strong></p>
<ul>
<li>Set up comprehensive monitoring</li>
<li>Implement distributed tracing</li>
<li>Use structured logging</li>
</ul>
</li>
<li>
<p><strong>Disaster Recovery</strong></p>
<ul>
<li>Implement backup strategies</li>
<li>Test recovery procedures</li>
<li>Use multi-region deployments for critical systems</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="troubleshooting">Troubleshooting<a href="#troubleshooting" class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="common-issues-and-solutions">Common Issues and Solutions<a href="#common-issues-and-solutions" class="hash-link" aria-label="Direct link to Common Issues and Solutions" title="Direct link to Common Issues and Solutions" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_W5Zx" id="terraform-issues">Terraform Issues<a href="#terraform-issues" class="hash-link" aria-label="Direct link to Terraform Issues" title="Direct link to Terraform Issues" translate="no">​</a></h4>
<p><strong>Issue</strong>: Provider authentication errors</p>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Solution: Set up authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export GOOGLE_APPLICATION_CREDENTIALS=&quot;path/to/service-account-key.json&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud auth application-default login</span><br></span></code></pre></div></div>
<p><strong>Issue</strong>: Resource quota exceeded</p>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Solution: Check and increase quotas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute project-info describe --project=PROJECT_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute quotas list --project=PROJECT_ID</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_W5Zx" id="gke-issues">GKE Issues<a href="#gke-issues" class="hash-link" aria-label="Direct link to GKE Issues" title="Direct link to GKE Issues" translate="no">​</a></h4>
<p><strong>Issue</strong>: Pods stuck in pending state</p>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Check node resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl top nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check pod events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe pod POD_NAME -n NAMESPACE</span><br></span></code></pre></div></div>
<p><strong>Issue</strong>: LoadBalancer service stuck in pending</p>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Check quota for load balancers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute addresses list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check firewall rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules list</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_W5Zx" id="database-issues">Database Issues<a href="#database-issues" class="hash-link" aria-label="Direct link to Database Issues" title="Direct link to Database Issues" translate="no">​</a></h4>
<p><strong>Issue</strong>: Connection timeout to Cloud SQL</p>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Check authorized networks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances describe INSTANCE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check private service connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud services vpc-peerings list --service=servicenetworking.googleapis.com</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_W5Zx" id="application-issues">Application Issues<a href="#application-issues" class="hash-link" aria-label="Direct link to Application Issues" title="Direct link to Application Issues" translate="no">​</a></h4>
<p><strong>Issue</strong>: Cloud Run service not accessible</p>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># Check IAM permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run services get-iam-policy SERVICE_NAME --region=REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Check service configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run services describe SERVICE_NAME --region=REGION</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="monitoring-and-debugging">Monitoring and Debugging<a href="#monitoring-and-debugging" class="hash-link" aria-label="Direct link to Monitoring and Debugging" title="Direct link to Monitoring and Debugging" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_W5Zx" id="health-checks">Health Checks<a href="#health-checks" class="hash-link" aria-label="Direct link to Health Checks" title="Direct link to Health Checks" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># GKE cluster health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl cluster-info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Database health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud redis instances list --region=REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cloud Run health</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run services list --region=REGION</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_W5Zx" id="log-analysis">Log Analysis<a href="#log-analysis" class="hash-link" aria-label="Direct link to Log Analysis" title="Direct link to Log Analysis" translate="no">​</a></h4>
<div class="language-bash codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-bash codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain"># View GKE logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl logs -f deployment/DEPLOYMENT_NAME -n NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># View Cloud Run logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud logs read &quot;resource.type=cloud_run_revision&quot; --limit=50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># View database logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud logs read &quot;resource.type=cloudsql_database&quot; --limit=50</span><br></span></code></pre></div></div>
<p>This comprehensive guide provides everything needed to deploy production-ready microservices on Google Cloud Platform using Terraform, including all the infrastructure components, security configurations, monitoring, and operational best practices.</p>
<pre tabindex="0" class="codeBlockStandalone_guBa thin-scrollbar codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><code class="codeBlockLines_Pso_"></code></pre>
<p><em>[This comprehensive guide continues with all the remaining modules, deployment instructions, best practices, and complete example configurations...]</em></p>
<p>Due to the extensive nature of this guide, I&#x27;ve shown the key foundation modules. The complete guide would include:</p>
<h2 class="anchor anchorWithStickyNavbar_W5Zx" id="remaining-sections-to-add">Remaining Sections to Add:<a href="#remaining-sections-to-add" class="hash-link" aria-label="Direct link to Remaining Sections to Add:" title="Direct link to Remaining Sections to Add:" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="-complete-module-set">📊 <strong>Complete Module Set</strong><a href="#-complete-module-set" class="hash-link" aria-label="Direct link to -complete-module-set" title="Direct link to -complete-module-set" translate="no">​</a></h3>
<ul>
<li><strong>Security Module</strong>: KMS keys, Secret Manager, IAM configurations</li>
<li><strong>Databases Module</strong>: Cloud SQL PostgreSQL with read replicas, Memorystore Redis</li>
<li><strong>Storage Module</strong>: Cloud Storage buckets with lifecycle policies, Filestore NFS</li>
<li><strong>Messaging Module</strong>: Pub/Sub topics and subscriptions with schemas</li>
<li><strong>Cloud Run Module</strong>: Serverless microservices with load balancers</li>
<li><strong>Monitoring Module</strong>: Cloud Operations integration</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="-deployment--operations">🚀 <strong>Deployment &amp; Operations</strong><a href="#-deployment--operations" class="hash-link" aria-label="Direct link to -deployment--operations" title="Direct link to -deployment--operations" translate="no">​</a></h3>
<ul>
<li><strong>Environment-specific configurations</strong> (dev/staging/prod)</li>
<li><strong>CI/CD pipeline templates</strong> for GitHub Actions, Cloud Build</li>
<li><strong>Kubernetes manifests</strong> with Kustomize overlays</li>
<li><strong>Helm charts</strong> for microservices deployment</li>
<li><strong>Backup and disaster recovery</strong> procedures</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_W5Zx" id="-best-practices--examples">📋 <strong>Best Practices &amp; Examples</strong><a href="#-best-practices--examples" class="hash-link" aria-label="Direct link to -best-practices--examples" title="Direct link to -best-practices--examples" translate="no">​</a></h3>
<ul>
<li><strong>Complete terraform.tfvars</strong> examples for each environment</li>
<li><strong>Microservices communication patterns</strong></li>
<li><strong>Security configurations</strong> and compliance</li>
<li><strong>Cost optimization</strong> strategies</li>
<li><strong>Monitoring and alerting</strong> setup</li>
<li><strong>Troubleshooting guides</strong> for common issues</li>
</ul>
<p>Would you like me to continue with any specific section of this comprehensive microservices guide? The foundation is now in place with the core infrastructure modules.</p>
<div class="language-text codeBlockContainer_gglu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_eM22"><pre tabindex="0" class="prism-code language-text codeBlock_E7hi thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Pso_"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I&#x27;ll continue with the remaining modules. This is a comprehensive guide, so let me create the remaining modules and configurations systematically.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;function_calls&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;invoke name=&quot;replace_string_in_file&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;parameter name=&quot;filePath&quot;&gt;/Users/tam.nguyenk/workspace/ecom/docs-site/docs/devops/gcp/microservices-terraform-guide.md</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/tamnk74/fullstack-dev/tree/main/docs-site/docs/devops/gcp/microservices-terraform-guide.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_r2F9" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_QYbU"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/fullstack-dev/docs/devops/gcp/gke-ingress-setup"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">GKE Ingress Setup Guide</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/fullstack-dev/docs/testing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Testing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_to3c thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#architecture-overview" class="table-of-contents__link toc-highlight">Architecture Overview</a><ul><li><a href="#high-level-architecture" class="table-of-contents__link toc-highlight">High-Level Architecture</a></li><li><a href="#technology-stack" class="table-of-contents__link toc-highlight">Technology Stack</a></li></ul></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a><ul><li><a href="#required-tools" class="table-of-contents__link toc-highlight">Required Tools</a></li><li><a href="#gcp-project-setup" class="table-of-contents__link toc-highlight">GCP Project Setup</a></li><li><a href="#service-account-setup" class="table-of-contents__link toc-highlight">Service Account Setup</a></li></ul></li><li><a href="#project-structure" class="table-of-contents__link toc-highlight">Project Structure</a></li><li><a href="#core-infrastructure-setup" class="table-of-contents__link toc-highlight">Core Infrastructure Setup</a><ul><li><a href="#provider-configuration" class="table-of-contents__link toc-highlight">Provider Configuration</a></li><li><a href="#main-variables" class="table-of-contents__link toc-highlight">Main Variables</a></li><li><a href="#main-terraform-configuration" class="table-of-contents__link toc-highlight">Main Terraform Configuration</a></li></ul></li><li><a href="#networking-module" class="table-of-contents__link toc-highlight">Networking Module</a></li><li><a href="#artifact-registry-configuration" class="table-of-contents__link toc-highlight">Artifact Registry Configuration</a><ul><li><a href="#artifact-registry-module" class="table-of-contents__link toc-highlight">Artifact Registry Module</a></li></ul></li><li><a href="#security-module" class="table-of-contents__link toc-highlight">Security Module</a><ul><li><a href="#kms-secret-manager-and-iam-configuration" class="table-of-contents__link toc-highlight">KMS, Secret Manager, and IAM Configuration</a></li></ul></li><li><a href="#databases-module" class="table-of-contents__link toc-highlight">Databases Module</a><ul><li><a href="#cloud-sql-postgresql-and-memorystore-redis" class="table-of-contents__link toc-highlight">Cloud SQL PostgreSQL and Memorystore Redis</a></li></ul></li><li><a href="#storage-module" class="table-of-contents__link toc-highlight">Storage Module</a><ul><li><a href="#cloud-storage-and-filestore-configuration" class="table-of-contents__link toc-highlight">Cloud Storage and Filestore Configuration</a></li></ul></li><li><a href="#messaging-module" class="table-of-contents__link toc-highlight">Messaging Module</a><ul><li><a href="#pubsub-configuration" class="table-of-contents__link toc-highlight">Pub/Sub Configuration</a></li></ul></li><li><a href="#cloud-run-module" class="table-of-contents__link toc-highlight">Cloud Run Module</a><ul><li><a href="#serverless-microservices-configuration" class="table-of-contents__link toc-highlight">Serverless Microservices Configuration</a></li></ul></li><li><a href="#monitoring-module" class="table-of-contents__link toc-highlight">Monitoring Module</a><ul><li><a href="#cloud-operations-integration" class="table-of-contents__link toc-highlight">Cloud Operations Integration</a></li></ul></li><li><a href="#complete-terraform-configuration" class="table-of-contents__link toc-highlight">Complete Terraform Configuration</a><ul><li><a href="#main-outputs" class="table-of-contents__link toc-highlight">Main Outputs</a></li></ul></li><li><a href="#deployment-guide" class="table-of-contents__link toc-highlight">Deployment Guide</a><ul><li><a href="#step-1-prerequisites-setup" class="table-of-contents__link toc-highlight">Step 1: Prerequisites Setup</a></li><li><a href="#step-2-plan-and-deploy" class="table-of-contents__link toc-highlight">Step 2: Plan and Deploy</a></li><li><a href="#step-3-post-deployment-setup" class="table-of-contents__link toc-highlight">Step 3: Post-Deployment Setup</a></li><li><a href="#step-4-deploy-application" class="table-of-contents__link toc-highlight">Step 4: Deploy Application</a></li><li><a href="#step-5-verify-deployment" class="table-of-contents__link toc-highlight">Step 5: Verify Deployment</a></li></ul></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a><ul><li><a href="#security-best-practices" class="table-of-contents__link toc-highlight">Security Best Practices</a></li><li><a href="#performance-optimization" class="table-of-contents__link toc-highlight">Performance Optimization</a></li><li><a href="#cost-optimization" class="table-of-contents__link toc-highlight">Cost Optimization</a></li><li><a href="#operational-excellence" class="table-of-contents__link toc-highlight">Operational Excellence</a></li></ul></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#common-issues-and-solutions" class="table-of-contents__link toc-highlight">Common Issues and Solutions</a></li><li><a href="#monitoring-and-debugging" class="table-of-contents__link toc-highlight">Monitoring and Debugging</a></li></ul></li><li><a href="#remaining-sections-to-add" class="table-of-contents__link toc-highlight">Remaining Sections to Add:</a><ul><li><a href="#-complete-module-set" class="table-of-contents__link toc-highlight">📊 <strong>Complete Module Set</strong></a></li><li><a href="#-deployment--operations" class="table-of-contents__link toc-highlight">🚀 <strong>Deployment &amp; Operations</strong></a></li><li><a href="#-best-practices--examples" class="table-of-contents__link toc-highlight">📋 <strong>Best Practices &amp; Examples</strong></a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/docs/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/docs/architecture-practices">Architecture Practices</a></li><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/docs/features">Features</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Development</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/docs/setup">Setup &amp; Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/docs/testing">Testing</a></li><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/docs/deployment">Deployment</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/fullstack-dev/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/tamnk74/fullstack-dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_aTGy"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/tamnk74/fullstack-dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub (Fullstack Dev)<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_aTGy"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Next.js for Production. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>